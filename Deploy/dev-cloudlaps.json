{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "languageVersion": "2.0",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.36.177.2456",
      "templateHash": "9823083938998075657"
    }
  },
  "parameters": {
    "ApplicationName": {
      "type": "string",
      "metadata": {
        "description": "Provide a unique name for the CloudLAPS Application. This will be used to name select other resources."
      }
    },
    "AppRegistrationId": {
      "type": "string",
      "metadata": {
        "description": "Provide the unique ID for the CloudLAPS App Registration."
      }
    },
    "FunctionAppName": {
      "type": "string",
      "metadata": {
        "description": "Provide a name for the Function App that consists of alphanumerics. Name must be globally unique in Azure and cannot start or end with a hyphen."
      }
    },
    "PortalWebAppName": {
      "type": "string",
      "metadata": {
        "description": "Provide a name for the portal website that consists of alphanumerics. Name must be globally unique in Azure and cannot start or end with a hyphen."
      }
    },
    "AppServicePlanSKU": {
      "type": "string",
      "defaultValue": "S1",
      "allowedValues": [
        "B1",
        "P1V2",
        "P1V3",
        "P2V2",
        "P2V3",
        "P3V2",
        "P3V3",
        "S1",
        "S2",
        "S3",
        "P1",
        "P2",
        "P3"
      ],
      "metadata": {
        "description": "Select the desired App Service Plan for the system. Select B1, SKU for minimum cost. Recommended SKU for optimal performance and cost is S1."
      }
    },
    "Tags": {
      "type": "object",
      "defaultValue": {},
      "metadata": {
        "description": "Provide any tags required by your organization (optional)"
      }
    }
  },
  "variables": {
    "KeyVaultName": "[format('{0}-kv', take(toLower(parameters('ApplicationName')), 21))]",
    "LogAnalyticsWorkspaceName": "[format('{0}-law', take(toLower(parameters('ApplicationName')), 20))]",
    "FunctionAppNameNoDash": "[replace(parameters('FunctionAppName'), '-', '')]",
    "FunctionAppNameNoDashUnderScore": "[replace(variables('FunctionAppNameNoDash'), '_', '')]",
    "PortalWebAppNameNoDash": "[replace(parameters('PortalWebAppName'), '-', '')]",
    "StorageAccountName": "[toLower(format('{0}-sa', take(variables('FunctionAppNameNoDashUnderScore'), 17)))]",
    "AppServicePlanName": "[format('{0}-plan', parameters('ApplicationName'))]",
    "FunctionAppInsightsName": "[format('{0}-fa-ai', parameters('ApplicationName'))]",
    "PortalAppInsightsName": "[format('{0}-wa-ai', parameters('ApplicationName'))]",
    "KeyVaultAppSettingsName": "[format('{0}-as', take(toLower(parameters('ApplicationName')), 21))]",
    "VirtualNetworkName": "[format('{0}-vnet', parameters('FunctionAppName'))]"
  },
  "resources": {
    "VirtualNetwork": {
      "type": "Microsoft.Network/virtualNetworks",
      "apiVersion": "2024-05-01",
      "name": "[variables('VirtualNetworkName')]",
      "location": "[resourceGroup().location]",
      "properties": {
        "addressSpace": {
          "addressPrefixes": [
            "10.0.0.0/16"
          ]
        },
        "privateEndpointVNetPolicies": "Disabled",
        "subnets": [
          {
            "name": "sn0",
            "properties": {
              "addressPrefix": "10.0.0.0/24",
              "serviceEndpoints": [
                {
                  "service": "Microsoft.Storage",
                  "locations": [
                    "[resourceGroup().location]"
                  ]
                },
                {
                  "service": "Microsoft.KeyVault",
                  "locations": [
                    "[resourceGroup().location]"
                  ]
                },
                {
                  "service": "Microsoft.Web",
                  "locations": [
                    "[resourceGroup().location]"
                  ]
                }
              ],
              "delegations": [
                {
                  "name": "Microsoft.Web/ServerFarms",
                  "properties": {
                    "serviceName": "Microsoft.Web/serverfarms"
                  },
                  "type": "Microsoft.Network/virtualNetworks/subnets/delegations"
                }
              ],
              "privateEndpointNetworkPolicies": "Disabled",
              "privateLinkServiceNetworkPolicies": "Enabled"
            },
            "type": "Microsoft.Network/virtualNetworks/subnets"
          }
        ],
        "virtualNetworkPeerings": [],
        "enableDdosProtection": false
      }
    },
    "StorageAccount": {
      "type": "Microsoft.Storage/storageAccounts",
      "apiVersion": "2024-01-01",
      "name": "[variables('StorageAccountName')]",
      "location": "[resourceGroup().location]",
      "sku": {
        "name": "Standard_LRS"
      },
      "kind": "StorageV2",
      "properties": {
        "supportsHttpsTrafficOnly": true,
        "accessTier": "Hot",
        "allowBlobPublicAccess": false,
        "minimumTlsVersion": "TLS1_2",
        "allowSharedKeyAccess": true
      },
      "tags": "[parameters('Tags')]"
    },
    "AppServicePlan": {
      "type": "Microsoft.Web/serverfarms",
      "apiVersion": "2024-04-01",
      "name": "[variables('AppServicePlanName')]",
      "location": "[resourceGroup().location]",
      "sku": {
        "name": "[parameters('AppServicePlanSKU')]"
      },
      "kind": "Windows",
      "properties": {},
      "tags": "[parameters('Tags')]"
    },
    "FunctionAppInsightsComponents": {
      "type": "Microsoft.Insights/components",
      "apiVersion": "2020-02-02",
      "name": "[variables('FunctionAppInsightsName')]",
      "location": "[resourceGroup().location]",
      "kind": "web",
      "properties": {
        "Application_Type": "web"
      },
      "tags": "[union(parameters('Tags'), createObject(format('hidden-link:{0}', resourceId('Microsoft.Web/sites', variables('FunctionAppInsightsName'))), 'Resource'))]"
    },
    "FunctionApp": {
      "type": "Microsoft.Web/sites",
      "apiVersion": "2024-04-01",
      "name": "[parameters('FunctionAppName')]",
      "location": "[resourceGroup().location]",
      "kind": "functionapp",
      "identity": {
        "type": "SystemAssigned"
      },
      "properties": {
        "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('AppServicePlanName'))]",
        "containerSize": 1536,
        "httpsOnly": true,
        "siteConfig": {
          "ftpsState": "Disabled",
          "alwaysOn": true,
          "minTlsVersion": "1.2",
          "powerShellVersion": "~7.4",
          "scmType": "None",
          "appSettings": [
            {
              "name": "AzureWebJobsDashboard",
              "value": "[format('DefaultEndpointsProtocol=https;AccountName={0};AccountKey={1}', variables('StorageAccountName'), listKeys('StorageAccount', '2024-01-01').keys[0].value)]"
            },
            {
              "name": "AzureWebJobsStorage",
              "value": "[format('DefaultEndpointsProtocol=https;AccountName={0};AccountKey={1}', variables('StorageAccountName'), listKeys('StorageAccount', '2024-01-01').keys[0].value)]"
            },
            {
              "name": "WEBSITE_CONTENTAZUREFILECONNECTIONSTRING",
              "value": "[format('DefaultEndpointsProtocol=https;AccountName={0};AccountKey={1}', variables('StorageAccountName'), listKeys('StorageAccount', '2024-01-01').keys[0].value)]"
            },
            {
              "name": "WEBSITE_CONTENTSHARE",
              "value": "[toLower('CloudLAPS')]"
            },
            {
              "name": "WEBSITE_RUN_FROM_PACKAGE",
              "value": "1"
            },
            {
              "name": "AzureWebJobsDisableHomepage",
              "value": "true"
            },
            {
              "name": "FUNCTIONS_EXTENSION_VERSION",
              "value": "~4"
            },
            {
              "name": "FUNCTIONS_WORKER_PROCESS_COUNT",
              "value": "3"
            },
            {
              "name": "PSWorkerInProcConcurrencyUpperBound",
              "value": "10"
            },
            {
              "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
              "value": "[reference('FunctionAppInsightsComponents').InstrumentationKey]"
            },
            {
              "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
              "value": "[reference('FunctionAppInsightsComponents').ConnectionString]"
            },
            {
              "name": "FUNCTIONS_WORKER_RUNTIME",
              "value": "powershell"
            }
          ]
        }
      },
      "dependsOn": [
        "AppServicePlan",
        "FunctionAppInsightsComponents",
        "StorageAccount"
      ]
    },
    "PortalApp": {
      "type": "Microsoft.Web/sites",
      "apiVersion": "2024-04-01",
      "name": "[variables('PortalWebAppNameNoDash')]",
      "location": "[resourceGroup().location]",
      "identity": {
        "type": "SystemAssigned"
      },
      "kind": "app",
      "properties": {
        "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('AppServicePlanName'))]",
        "siteConfig": {
          "alwaysOn": true,
          "metadata": [
            {
              "name": "CURRENT_STACK",
              "value": "dotnetcore"
            }
          ]
        }
      },
      "dependsOn": [
        "AppServicePlan"
      ]
    },
    "PortalAppInsightsComponents": {
      "type": "Microsoft.Insights/components",
      "apiVersion": "2020-02-02",
      "name": "[variables('PortalAppInsightsName')]",
      "location": "[resourceGroup().location]",
      "kind": "web",
      "properties": {
        "Application_Type": "web"
      },
      "tags": "[union(parameters('Tags'), createObject(format('hidden-link:{0}', resourceId('Microsoft.Web/sites', parameters('PortalWebAppName'))), 'Resource'))]"
    },
    "KeyVault": {
      "type": "Microsoft.KeyVault/vaults",
      "apiVersion": "2022-07-01",
      "name": "[variables('KeyVaultName')]",
      "location": "[resourceGroup().location]",
      "properties": {
        "enabledForDeployment": false,
        "enabledForTemplateDeployment": false,
        "enabledForDiskEncryption": false,
        "tenantId": "[subscription().tenantId]",
        "accessPolicies": [
          {
            "tenantId": "[reference('FunctionApp', '2024-04-01', 'full').identity.tenantId]",
            "objectId": "[reference('FunctionApp', '2024-04-01', 'full').identity.principalId]",
            "permissions": {
              "secrets": [
                "get",
                "set"
              ]
            }
          },
          {
            "tenantId": "[reference('PortalApp', '2024-04-01', 'full').identity.tenantId]",
            "objectId": "[reference('PortalApp', '2024-04-01', 'full').identity.principalId]",
            "permissions": {
              "secrets": [
                "get"
              ]
            }
          }
        ],
        "networkAcls": {
          "bypass": "AzureServices",
          "defaultAction": "Deny",
          "virtualNetworkRules": [
            {
              "id": "[resourceId(resourceGroup().name, 'Microsoft.Network/virtualNetworks/subnets', variables('VirtualNetworkName'), 'sn0')]",
              "ignoreMissingVnetServiceEndpoint": false
            }
          ]
        },
        "sku": {
          "name": "standard",
          "family": "A"
        }
      },
      "dependsOn": [
        "FunctionApp",
        "PortalApp"
      ]
    },
    "KeyVaultAppSettings": {
      "type": "Microsoft.KeyVault/vaults",
      "apiVersion": "2022-07-01",
      "name": "[variables('KeyVaultAppSettingsName')]",
      "location": "[resourceGroup().location]",
      "properties": {
        "enabledForDeployment": false,
        "enabledForTemplateDeployment": false,
        "enabledForDiskEncryption": false,
        "tenantId": "[subscription().tenantId]",
        "accessPolicies": [
          {
            "tenantId": "[reference('FunctionApp', '2024-04-01', 'full').identity.tenantId]",
            "objectId": "[reference('FunctionApp', '2024-04-01', 'full').identity.principalId]",
            "permissions": {
              "secrets": [
                "get"
              ]
            }
          },
          {
            "tenantId": "[reference('PortalApp', '2024-04-01', 'full').identity.tenantId]",
            "objectId": "[reference('PortalApp', '2024-04-01', 'full').identity.principalId]",
            "permissions": {
              "secrets": [
                "get"
              ]
            }
          }
        ],
        "networkAcls": {
          "bypass": "AzureServices",
          "defaultAction": "Deny",
          "virtualNetworkRules": [
            {
              "id": "[resourceId(resourceGroup().name, 'Microsoft.Network/virtualNetworks/subnets', variables('VirtualNetworkName'), 'sn0')]",
              "ignoreMissingVnetServiceEndpoint": false
            }
          ]
        },
        "sku": {
          "name": "standard",
          "family": "A"
        }
      },
      "dependsOn": [
        "FunctionApp",
        "PortalApp"
      ]
    },
    "WorkspaceIdSecret": {
      "type": "Microsoft.KeyVault/vaults/secrets",
      "apiVersion": "2022-07-01",
      "name": "[format('{0}/{1}', variables('KeyVaultAppSettingsName'), 'LogAnalyticsWorkspaceId')]",
      "properties": {
        "value": "[reference('LogAnalyticsWorkspace').customerId]"
      },
      "dependsOn": [
        "KeyVaultAppSettings",
        "LogAnalyticsWorkspace"
      ]
    },
    "SharedKeySecret": {
      "type": "Microsoft.KeyVault/vaults/secrets",
      "apiVersion": "2022-07-01",
      "name": "[format('{0}/{1}', variables('KeyVaultAppSettingsName'), 'LogAnalyticsWorkspaceSharedKey')]",
      "properties": {
        "value": "[listKeys('LogAnalyticsWorkspace', '2021-06-01').primarySharedKey]"
      },
      "dependsOn": [
        "KeyVaultAppSettings",
        "LogAnalyticsWorkspace"
      ]
    },
    "FunctionAppSettings": {
      "type": "Microsoft.Web/sites/config",
      "apiVersion": "2022-03-01",
      "name": "[format('{0}/{1}', parameters('FunctionAppName'), 'appsettings')]",
      "properties": {
        "AzureWebJobsDashboard": "[format('DefaultEndpointsProtocol=https;AccountName={0};AccountKey={1}', variables('StorageAccountName'), listKeys('StorageAccount', '2024-01-01').keys[0].value)]",
        "AzureWebJobsStorage": "[format('DefaultEndpointsProtocol=https;AccountName={0};AccountKey={1}', variables('StorageAccountName'), listKeys('StorageAccount', '2024-01-01').keys[0].value)]",
        "WEBSITE_CONTENTAZUREFILECONNECTIONSTRING": "[format('DefaultEndpointsProtocol=https;AccountName={0};AccountKey={1}', variables('StorageAccountName'), listKeys('StorageAccount', '2024-01-01').keys[0].value)]",
        "WEBSITE_CONTENTSHARE": "[toLower('CloudLAPS')]",
        "WEBSITE_RUN_FROM_PACKAGE": "1",
        "AzureWebJobsDisableHomepage": "true",
        "FUNCTIONS_EXTENSION_VERSION": "~4",
        "FUNCTIONS_WORKER_PROCESS_COUNT": "3",
        "PSWorkerInProcConcurrencyUpperBound": "10",
        "APPINSIGHTS_INSTRUMENTATIONKEY": "[reference('FunctionAppInsightsComponents').InstrumentationKey]",
        "APPLICATIONINSIGHTS_CONNECTION_STRING": "[reference('FunctionAppInsightsComponents').ConnectionString]",
        "FUNCTIONS_WORKER_RUNTIME": "powershell",
        "UpdateFrequencyDays": "3",
        "KeyVaultName": "[variables('KeyVaultName')]",
        "DebugLogging": "False",
        "PasswordLength": "16",
        "PasswordAllowedCharacters": "ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz.:;,-_!?$%*=+&<>@#()23456789",
        "LogAnalyticsWorkspaceId": "[format('@Microsoft.KeyVault(VaultName={0};SecretName=LogAnalyticsWorkspaceId)', variables('KeyVaultAppSettingsName'))]",
        "LogAnalyticsWorkspaceSharedKey": "[format('@Microsoft.KeyVault(VaultName={0};SecretName=LogAnalyticsWorkspaceSharedKey)', variables('KeyVaultAppSettingsName'))]",
        "LogTypeClient": "CloudLAPSClient"
      },
      "dependsOn": [
        "FunctionApp",
        "FunctionAppInsightsComponents",
        "FunctionAppZipDeploy",
        "StorageAccount"
      ]
    },
    "PortalAppServiceAppSettings": {
      "type": "Microsoft.Web/sites/config",
      "apiVersion": "2022-03-01",
      "name": "[format('{0}/{1}', variables('PortalWebAppNameNoDash'), 'appsettings')]",
      "properties": {
        "AzureWebJobsSecretStorageKeyVaultName": "[variables('KeyVaultName')]",
        "APPLICATIONINSIGHTS_CONNECTION_STRING": "[reference('PortalAppInsightsComponents').ConnectionString]",
        "APPINSIGHTS_INSTRUMENTATIONKEY": "[reference('PortalAppInsightsComponents').InstrumentationKey]",
        "AzureAd__TenantId": "[subscription().tenantId]",
        "AzureAd__ClientId": "[parameters('AppRegistrationId')]",
        "KeyVault__Uri": "[reference('KeyVault').vaultUri]",
        "LogAnalytics__WorkspaceId": "[format('@Microsoft.KeyVault(VaultName={0};SecretName=LogAnalyticsWorkspaceId)', variables('KeyVaultAppSettingsName'))]",
        "LogAnalytics__SharedKey": "[format('@Microsoft.KeyVault(VaultName={0};SecretName=LogAnalyticsWorkspaceSharedKey)', variables('KeyVaultAppSettingsName'))]",
        "LogAnalytics__LogType": "CloudLAPSAudit"
      },
      "dependsOn": [
        "KeyVault",
        "PortalApp",
        "PortalAppInsightsComponents",
        "PortalZipDeploy"
      ]
    },
    "FunctionAppZipDeploy": {
      "type": "Microsoft.Web/sites/extensions",
      "apiVersion": "2024-11-01",
      "name": "[format('{0}/{1}', parameters('FunctionAppName'), 'ZipDeploy')]",
      "properties": {
        "packageUri": "https://github.com/AptLogic/CloudLAPS/releases/download/v1.3.0/CloudLAPS-FunctionApp1.3.0.zip"
      },
      "dependsOn": [
        "FunctionApp"
      ]
    },
    "PortalZipDeploy": {
      "type": "Microsoft.Web/sites/extensions",
      "apiVersion": "2024-11-01",
      "name": "[format('{0}/{1}', variables('PortalWebAppNameNoDash'), 'ZipDeploy')]",
      "properties": {
        "packageUri": "https://github.com/AptLogic/CloudLAPS/releases/download/v1.3.0/CloudLAPS-Portal1.1.0.zip"
      },
      "dependsOn": [
        "FunctionAppZipDeploy",
        "PortalApp"
      ]
    },
    "LogAnalyticsWorkspace": {
      "type": "Microsoft.OperationalInsights/workspaces",
      "apiVersion": "2021-06-01",
      "name": "[variables('LogAnalyticsWorkspaceName')]",
      "location": "[resourceGroup().location]",
      "properties": {
        "sku": {
          "name": "PerGB2018"
        }
      }
    }
  }
}